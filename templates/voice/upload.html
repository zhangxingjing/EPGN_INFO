{% extends 'base.html' %}

{% load static %}

{% block title %} VOICE UPLOAD{% endblock %}

{% block link %}
    <link rel="stylesheet" href="{% static 'ele/index.css' %}">
    <link rel="stylesheet" href="{% static 'layui/css/layui.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'layui/css/admin.css' %}" media="all">
    <link rel="stylesheet" href="{% static 'layui/css/modules/layer/default/layer.css' %}">
    <style>
        .layui-form-label {
            font-size: 16px;
            font-weight: bold;
        }

        .layui-elem-field legend {
            font-weight: bold;
        }

        .layui-table td, .layui-table th {
            font-weight: bold;
        }

        .list-data {
            font-size: 18px;
            padding: 3px;
            height: 35px;
            line-height: 35px
        }

        .list-data img {
            height: 50%;
            padding-top: 2px;
            width: auto
        }

        #app {
            margin-top: 30px;
        }

        h3 {
            display: flex;
            flex-direction: row;
            font-size: 22px;
        }

        h3:before,
        h3:after {
            content: "";
            flex: 1 1;
            border-bottom: 1px solid #000;
            margin: 10px;
        }

        .item-flex {
            display: flex;
            justify-content: space-around;
        }

        #submit-button {
            margin-top: 40px;
            display: flex;
            justify-content: center;
        }

        #app {
            display: flex;
        }

        #content1 {
            width: 30%;
            margin-left: 20%;
        }

        #content2 {
            width: 30%;
        }

        #content1 div {
            display: flex;
            margin-bottom: 5px;
        }

        #content1 div span:nth-child(1) {
            width: 150px;
            line-height: 45px;
        }

        .el-input__inner {
            width: auto;
        }

        .el-input {
            width: auto;
        }

        #content2 {
            margin-left: 10%;
        }

        #content2 div {
            display: flex;
            margin-bottom: 5px;
        }

        #content2 div span:nth-child(1) {
            width: 150px;
            line-height: 45px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="layui-fluid" id="complain_upload" v-loading="loading" element-loading-text="上传中,请稍等...">
        <div class="layui-card" style="padding: 10px">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>音频信息表</legend>
            </fieldset>
            <div id="app">
                <div id="content1">
                    <div>
                        <div><span><span style="color: red">*</span>车型：</span></div>
                        <el-select v-model="car_modal" placeholder="请选择">
                            <el-option v-for="item in carmodal"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.id"></el-option>
                        </el-select>
                    </div>
                    <div>
                        <div><span>发动机：</span></div>
                        <el-select v-model="car_engine" placeholder="请选择">
                            <el-option v-for="item in engine"
                                       :key="item"
                                       :label="item"
                                       :value="item"></el-option>
                        </el-select>
                    </div>
                    <div>
                        <div><span>变速箱：</span></div>
                        <el-select v-model="car_gearbox" placeholder="请选择">
                            <el-option v-for="item in gearbox"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.id"></el-option>
                        </el-select>
                    </div>
                    <div>
                        <div><span>功率：</span></div>
                        <el-select v-model="car_power" placeholder="请选择">
                            <el-option v-for="item in power"
                                       :key="item"
                                       :label="item"
                                       :value="item"></el-option>
                        </el-select>
                    </div>
                    <div>
                        <div><span><span style="color: red">*</span>上传人：</span></div>
                        <el-input v-model="user_name" clearable placeholder="上传人"></el-input>
                    </div>
                </div>
                <div id="content2">
                    <div>
                        <div><span><span style="color: red">*</span>工况：</span></div>
                        <el-select v-model="condition" placeholder="请选择工况" @change="changecondition">
                            <el-option v-for="item in car_condition"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>

                    <div v-show="Accelerate_show">
                        <div><span></span></div>
                        <el-select v-model="acceleratelist" placeholder="请选择具体工况">
                            <el-option v-for="item in accelerate_list"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>
                    <div v-show="Accelerate_show">
                        <div><span></span></div>
                        <el-select v-model="accelerategear" placeholder="请选择档位">
                            <el-option v-for="item in accelerate_gear"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>

                    <div v-show="Uniform_speed">
                        <div><span></span></div>
                        <el-input v-model="uniform_speed" clearable placeholder="填写车速"
                        ></el-input>
                    </div>


                    <div v-show="Rolling_noise">
                        <div><span></span></div>
                        <el-select v-model="roll_road_condition" placeholder="选择路面">
                            <el-option v-for="item in roll_condition_list"
                                       :key="item.name"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>
                    <div v-show="Rolling_noise">
                        <div><span></span></div>
                        <el-input v-model="roll_speed" clearable placeholder="填写车速"
                        ></el-input>
                    </div>


                    <div v-show="Idle_state">
                        <div><span></span></div>
                        <el-select v-model="Idle_state_gear" placeholder="选择档位">
                            <el-option v-for="item in Idle_gear_list"
                                       :key="item.name"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>
                    <div v-show="Idle_state">
                        <div><span></span></div>
                        <el-select v-model="Idle_state_condition" placeholder="空调状态">
                            <el-option v-for="item in Idle_condition_list"
                                       :key="item.name"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>


                    <div v-show="Chassis_comfort">
                        <div><span></span></div>
                        <el-select v-model="comfort_road_condition" placeholder="选择路面">
                            <el-option v-for="item in comfort_condition_list"
                                       :key="item.name"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>
                    <div v-show="Chassis_comfort">
                        <div><span></span></div>
                        <el-input v-model="comfort_speed" clearable placeholder="填写车速"
                        ></el-input>
                    </div>
                    <div>
                        <div><span><span style="color: red">*</span>声源：</span></div>
                        <el-select v-model="sound_source" placeholder="请选择" @change="changeSource">
                            <el-option v-for="item in source"
                                       :key="item.id"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>


                    <div v-show="Supply_info">
                        <div><span></span></div>
                        <el-select v-model="supplyInfo" placeholder="请选择">
                            <el-option v-for="item in supplyList"
                                       :key="item.name"
                                       :label="item.name"
                                       :value="item.name"></el-option>
                        </el-select>
                    </div>


                    <div>
                        <div><span><span style="color: red">*</span>声音描述：</span></div>
                        <el-input v-model="voiceDescription" placeholder="具体描述" clearable></el-input>
                    </div>
                    <div>
                        <div><span><span style="color: red">*</span>备注信息：</span></div>
                        <el-input
                                type="textarea"
                                :autosize="{ minRows: 2, maxRows: 4}"
                                placeholder="请输入内容"
                                v-model="detailed_description">
                        </el-input>
                    </div>


                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>文件上传</legend>
            </fieldset>
            <div id="app2">
                <el-form :inline="true" class="demo-form-inline item-flex">
                    <el-form-item label="音频原始数据：">
                        <el-upload
                                class="upload-demo"
                                action="#"
                                :on-preview="handlePreview"
                                :on-remove="handleRemove"
                                :before-remove="beforeRemove"
                                :on-success="hanlesuccess"
                                :on-change="changefile"
                                multiple
                                :limit="1"
                                :on-exceed="handleExceed"
                                :file-list="complain_filelist"
                                :auto-upload="false"

                        >
                            <el-button size="small" type="primary">选择文件</el-button>
                            <div slot="tip" class="el-upload__tip">只能上传hdf/dat文件</div>
                        </el-upload>
                    </el-form-item>
                    <el-form-item label="音频特征图：">
                        <el-upload
                                class="upload-demo"
                                action="#"
                                :on-preview="handlePreview"
                                :on-remove="handleRemove"
                                :before-remove="beforeRemove"
                                :on-change="changefile"
                                multiple
                                :limit="2"
                                :on-exceed="handleExceed2"
                                :auto-upload="false"
                                :file-list="complain_photo">
                            <el-button size="small" type="primary">选择文件</el-button>
                            <div slot="tip" class="el-upload__tip">只能上传jpg/png/bmp文件</div>
                        </el-upload>
                    </el-form-item>
                    <el-form-item label="音频文件：">
                        <el-upload
                                class="upload-demo"
                                action="#"
                                :on-preview="handlePreview"
                                :on-remove="handleRemove"
                                :before-remove="beforeRemove"
                                :on-change="changefile"
                                multiple
                                :limit="1"
                                :on-exceed="handleExceed"
                                :auto-upload="false"
                                :file-list="complain_audio">
                            <el-button size="small" type="primary">选择文件</el-button>
                            <div slot="tip" class="el-upload__tip">只能上传mp3/wav文件</div>
                        </el-upload>
                    </el-form-item>
                </el-form>
                <div id="submit-button">
                    <el-button type="primary" style="background-color: #009688;" @click="submitupload">开始上传</el-button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="{% static 'js/vue_2.6.10.js' %}"></script>
    <script type="text/javascript" src="{% static 'ele/index.js' %}"></script>
    <script type="text/javascript" src="{% static "layui/layui.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery-1.7.2.min.js" %}"></script>
    <script type="text/javascript" src="{% static 'js/axios-0.18.0.min.js' %}"></script>
    <script>
        layui.use(['upload', 'form', 'layedit', 'laydate', 'element', 'table'], function () {
            var form = layui.form,
                layer = layui.layer,
                layedit = layui.layedit,
                $ = layui.jquery,
                upload = layui.upload;
            table = layui.table;
            table.render({
                elem: '#test'
                , url: '/voice/'
                , page: true
                , toolbar: '#toolbarDemo'
                , defaultToolbar: ['filter', 'exports', 'print', {title: '提示', layEvent: 'LAYTABLE_TIPS', icon: 'layui-icon-tips'}]
                , title: '用户数据表'
                , cols: [[
                    {field: 'car_model', title: '车型', width: 160, fixed: 'left', sort: true}
                    , {field: 'propulsion', title: '发动机', width: 140, edit: 'text'}
                    , {field: 'gearbox', title: '变速箱', width: 120, edit: 'text'}
                    , {field: 'power', title: '功率', width: 100, edit: 'text', sort: true}
                    , {field: 'status', title: '工况', width: 240}
                    , {field: 'source', title: '声源', width: 130}
                    , {field: 'remark', title: '声音描述', width: 300}
                    , {field: 'depict', title: '备注信息'}
                    , {field: 'reason', title: '上传人', width: 120, hide: true}
                    , {fixed: 'right', title: '操作', toolbar: '#barDemo', width: 150}
                ]]
            })
        })

        new Vue({
            el: '#complain_upload',
            data: function () {
                return {
                    car_modal: '',
                    carmodal: [],
                    car_engine: '',
                    engine: [],
                    car_gearbox: '',
                    gearbox: [],
                    source: '',
                    sound_source: '',
                    car_power: '',
                    power: [],
                    condition: '',
                    car_condition: [],
                    user_name: '',
                    key_parts: '',
                    voiceDescription: '',
                    detailed_description: '',
                    Accelerate_show: false,
                    Uniform_speed: false,
                    accelerategear: '',
                    acceleratelist: '',
                    uniform_speed: '',
                    Rolling_noise: false,
                    roll_road_condition: '',
                    roll_speed: '',
                    Chassis_comfort: false,
                    Idle_state: false,
                    Idle_state_gear: '',
                    Idle_state_condition: '',
                    comfort_road_condition: '',
                    comfort_speed: '',
                    filelist_hdf: [],
                    filelist_pic_1: '',
                    filelist_pic_2: '',
                    filelist_audio: [],
                    loading: false,
                    Supply_info: false,
                    supplyInfo: '',
                    supplyList: '',
                    accelerate_list: [{name: "VZ"}, {name: "VS"}, {name: "TZ"}, {name: "TS"}, {name: "加减速均有"}, {name: "不清楚"}],
                    accelerate_gear: [{name: "1"}, {name: "2"}, {name: "3"}, {name: "4"}, {name: "5"}, {name: "6"}, {name: "7"}, {name: "D"}, {name: "B"}, {name: "档位无关"}],
                    roll_condition_list: [{name: "Stuckern"}, {name: "Kleinpflaster"}, {name: "Kerben"}, {name: "Rauhasphalt"}, {name: "Glatteasphalt"}, {name: "其他"}],
                    comfort_condition_list: [{name: "减速带"}, {name: "Stuckern"}, {name: "负坎"}, {name: "沟槽路"}, {name: "金属横档条"}, {name: "随机水泥路面"}, {name: "其他"}],
                    Idle_gear_list: [{name: "P"}, {name: "R"}, {name: "N"}, {name: "D"}],
                    Idle_condition_list: [{name: "空调-开"}, {name: "空调-关"}],
                    complain_report: [],
                    complain_audio: [],
                    complain_filelist: [],
                    complain_photo: [],
                    powerInfo: [{id: 1001, name: "高压油泵"}, {id: 1002, name: "活塞"}, {id: 1003, name: "涡轮增压器"}, {id: 1004, name: "皮带"}, {id: 1005, name: "电驱总成"}],
                    airSystem: [{id: 2001, name: "进气系统"}, {id: 2001, name: "排气系统"}],
                    assistInfo: [{id: 3001, name: "发电机"}, {id: 3002, name: "压缩机"}, {id: 3003, name: "空调"}, {id: 3004, name: "大灯"}, {id: 3005, name: "鼓风机"}, {id: 3006, name: "雨刮"}, {id: 3007, name: "天窗"}, {id: 3008, name: "冷却风扇"}, {id: 3009, name: "摇窗机"}],
                    chassisInfo: [{id: 4001, name: "轮胎"}, {id: 4001, name: "传动轴"}, {id: 4003, name: "刹车蓄能器"}],
                }
            },
            methods: {
                changeSource() {
                    if (this.sound_source == "动力总成") {
                        this.Supply_info = true;
                        this.supplyList = this.powerInfo;
                    } else if (this.sound_source == "进排气系统") {
                        this.Supply_info = true;
                        this.supplyList = this.airSystem;

                    } else if (this.sound_source == "辅助总成") {
                        this.Supply_info = true;
                        this.supplyList = this.assistInfo;

                    } else if (this.sound_source == "底盘") {
                        this.Supply_info = true;
                        this.supplyList = this.chassisInfo;
                    } else {
                        this.Supply_info = false;
                    }
                },
                changecondition() {
                    if (this.condition == "加/减速") {
                        this.Accelerate_show = true;
                        this.Uniform_speed = false;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = false;
                        this.Idle_state = false;
                    } else if (this.condition == "匀速") {
                        this.Accelerate_show = false;
                        this.Uniform_speed = true;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = false;
                        this.Idle_state = false;
                    } else if (this.condition == "滚动噪声/轮胎噪声") {
                        this.Accelerate_show = false;
                        this.Uniform_speed = false;
                        this.Rolling_noise = true;
                        this.Chassis_comfort = false;
                        this.Idle_state = false;
                    } else if (this.condition == "底盘舒适性") {
                        this.Accelerate_show = false;
                        this.Uniform_speed = false;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = true;
                        this.Idle_state = false;
                    } else if (this.condition == "怠速") {
                        this.Accelerate_show = false;
                        this.Uniform_speed = false;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = false;
                        this.Idle_state = true;
                    } else if (this.condition == "其他") {
                        this.Accelerate_show = false;
                        this.Uniform_speed = true;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = false;
                        this.Idle_state = false;
                    } else {
                        this.Accelerate_show = false;
                        this.Uniform_speed = false;
                        this.Rolling_noise = false;
                        this.Chassis_comfort = false;
                        this.Idle_state = false;
                    }
                },
                submitupload() {
                     if (this.car_modal == '') {
                        this.$message({message: '请选择车型信息!', type: 'warning'})
                        return false
                    }
                      if (this.condition == '') {
                        this.$message({message: '请选择工况!', type: 'warning'})
                        return false
                    }
                    if (this.sound_source == '') {
                        this.$message({message: '请填写声音来源!', type: 'warning'})
                        return false
                    }
                    if(this.voiceDescription==''){
                        this.$message({message: '请填写声音描述!', type: 'warning'})
                        return false
                    }
                     if (this.detailed_description == '') {
                        this.$message({message: '请填写备注信息!', type: 'warning'})
                        return false
                    }

                    if (this.filelist_hdf.length == 0) {
                        this.$message({message: '请上传音频原始数据!', type: 'warning'})
                        return false
                    }


                    this.loading = true;
                    let formData = new FormData();
                    let soundSource = "整车-"+this.sound_source + "-" + this.supplyInfo;
                    formData.append('depict', this.detailed_description);
                    formData.append('source', soundSource);
                    formData.append('car_model', this.car_modal);
                    formData.append('propulsion', this.car_engine);
                    formData.append('gearbox', this.car_gearbox);
                    formData.append('power', this.car_power);
                    formData.append('username', this.user_name);
                    formData.append('remark', this.voiceDescription);
                    if (this.condition == "加/减速") {
                        let condition_list = this.condition + "-" + this.acceleratelist + "-" + this.accelerategear;
                        formData.append('status', condition_list);
                    } else if (this.condition == "匀速") {
                        let condition_list = this.condition + "-" + this.uniform_speed + "km/h";
                        formData.append('status', condition_list);
                    } else if (this.condition == "滚动噪声/轮胎噪声") {
                        let condition_list = this.condition + "-" + this.roll_road_condition + "-" + this.roll_speed + "km/h";
                        formData.append('status', condition_list);
                    } else if (this.condition == "底盘舒适性") {
                        let condition_list = this.condition + "-" + this.comfort_road_condition + "-" + this.comfort_speed + "km/h";
                        formData.append('status', condition_list);
                    } else if (this.condition == "怠速") {
                        let condition_list = this.condition + "-" + this.Idle_state_gear + "-" + this.Idle_state_condition;
                        formData.append('status', condition_list);
                    } else if (this.condition == "其他") {
                        let condition_list = this.condition + "-" + this.uniform_speed + "km/h";
                        formData.append('status', condition_list);
                    } else {
                        formData.append('status', this.condition);
                    }
                    formData.append('conplain_file', this.filelist_hdf);
                    formData.append('conplain_pic_1', this.filelist_pic_1);
                    formData.append('conplain_pic_2', this.filelist_pic_2);
                    formData.append('conplain_audio', this.filelist_audio);
                    axios({
                        url: "/voice/",
                        method: 'post',
                        headers: {"Content-Type": "multipart/form-data"},
                        data: formData,
                    }).then((response) => {
                        if (response.data.code == 1) {
                            this.loading = false;
                            Vue.prototype.$message({message: '文件上传成功!', type: 'success'});
                        } else {
                            this.loading = false;
                            Vue.prototype.$message({message: '文件上传失败,请联系管理员!', type: 'error'});
                        }
                    }).catch((error) => {
                        this.loading = false;
                        Vue.prototype.$message({message: '文件上传失败,请联系管理员!', type: 'error'});
                    })
                },
                handleRemove(file, fileList) {
                },
                hanlesuccess(file) {
                },
                changefile(file, filelist) {
                    for (let i = 0; i < filelist.length; i++) {
                        // let fileEndName = filelist[i].name.split('.').pop().toLowerCase();
                        if (i == 0) {
                            if (filelist[0].name.toLowerCase().indexOf('.hdf') != -1) {
                                this.filelist_hdf = filelist[0].raw;
                            } else if (filelist[0].name.toLowerCase().indexOf('.dat') != -1) {
                                this.filelist_hdf = filelist[0].raw;
                            } else if (filelist[0].name.toLowerCase().indexOf('.jpg') != -1) {
                                this.filelist_pic_1 = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.jpeg') != -1) {
                                this.filelist_pic_1 = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.png') != -1) {
                                this.filelist_pic_1 = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.bmp') != -1) {
                                this.filelist_pic_1 = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.mp3') != -1) {
                                this.filelist_audio = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.wav') != -1) {
                                this.filelist_audio = filelist[0].raw
                            } else if (filelist[0].name.toLowerCase().indexOf('.ppt') != -1) {
                                this.filelist_ppt = filelist[0].raw
                            } else {
                                this.filelist_pic_1 = filelist[0].raw
                            }
                        } else {
                            this.filelist_pic_2 = filelist[1].raw
                        }
                    }
                },
                handlePreview(file) {
                },
                handleExceed(files, fileList) {
                    this.$message.warning(`当前限制选择 1 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
                },
                handleExceed2(files, fileList) {
                    this.$message.warning(`当前限制选择 2 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
                },
                beforeRemove(file, fileList) {
                    return this.$confirm(`确定移除 ${file.name}？`);
                },
            },

            created: function () {
                var self = this;
                self.user_name = sessionStorage.username;
                $.ajax({
                    url: '/voice/wait/',
                    dataType: "json",
                    type: "get",
                    success: function (result) {
                        self.car_condition = result.condition;
                        self.carmodal = result.car_modal;
                        self.engine = result.car_engine;
                        self.gearbox = result.car_gearbox;
                        self.power = result.power;
                        self.source = result.source;
                    }
                });
            }
        })
    </script>
{% endblock %}




